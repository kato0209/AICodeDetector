
  if param.shape.with_rank_at_least(1)[-1].value is not None:
    raise ValueError("Lagrange multiplier must be a scalar.")
  if param.shape.with_rank_at_least(1)[-1].value is not None:
    return param
  if param.shape.with_rank_at_least(1)[-1].value is not None:
    return param
  if param.shape.with_rank_at_least(1)[-1].value is not None:
    return param
  if param.shape.with_rank_at_least(